{{!--
Traits Field Component

Usage:
{{> "systems/avant/templates/shared/partials/traits-field"
name="system.traits"
displayTraits=displayTraits
label="Traits"
hint="Add traits to categorize this item"
class="custom-class"
editable=editable
}}

Required: name, label
Optional: hint, class, editable (defaults to true), displayTraits
--}}

{{!-- REMOVED DEBUG HELPERS - they were causing template rendering failures --}}

<div class="form-group {{#if class}}{{class}}{{/if}}">
    <label for="{{name}}" class="form-label">
        {{label}}
    </label>

    {{#if (ne editable false)}}
    <!-- Edit mode: Trait chip input with autocomplete -->
    <div class="trait-chip-input">
        <div class="trait-chips">
            {{!-- Process displayTraits if available, otherwise fallback to value (raw IDs) --}}
            {{#if displayTraits}}
            {{#each displayTraits as |trait|}}
            <div class="trait-chip" style="{{traitChipStyle trait}}" {{traitChipData trait}}>
                {{#if trait.icon}}<i class="{{trait.icon}}" aria-hidden="true"></i>{{/if}}
                <span class="trait-name">{{trait.name}}</span>
                <button type="button" class="trait-remove" data-action="removeTrait" data-trait-id="{{trait.id}}"
                    aria-label="Remove {{trait.name}}">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            {{/each}}
            {{else if value}}
            {{#each value as |traitId|}}
            <div class="trait-chip" style="{{traitChipStyleFromId traitId}}" data-trait-id="{{traitId}}">
                {{#if (traitIconFromId traitId)}}<i class="{{traitIconFromId traitId}}" aria-hidden="true"></i>{{/if}}
                <span class="trait-name">{{traitNameFromId traitId}}</span>
                <button type="button" class="trait-remove" data-action="removeTrait" data-trait-id="{{traitId}}"
                    aria-label="Remove {{traitNameFromId traitId}}">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            {{/each}}
            {{/if}}
        </div>

        <!-- Drag-and-Drop Zone (Phase 2 Feature) -->
        <div class="trait-drop-zone" data-drop-zone="trait" style="display: none;">
            <div class="drop-zone-content">
                <i class="fas fa-plus-circle"></i>
                <span class="drop-zone-text">Drag traits from compendium here</span>
            </div>
            <div class="drop-zone-highlight"></div>
        </div>

        <div class="trait-input-container">
            <input type="text" class="trait-autocomplete" placeholder="Type to add traits..." autocomplete="off"
                data-target="{{name}}" {{#if hint}}aria-describedby="{{name}}-hint" {{/if}}>
            <div class="trait-suggestions" style="display: none;"></div>
        </div>
    </div>
    {{else}}
    <!-- Read-only mode: Display trait chips without input -->
    <div class="trait-display">
        {{#if displayTraits}}
        {{#each displayTraits as |trait|}}
        <div class="trait-chip trait-chip-readonly" style="{{traitChipStyle trait}}" {{traitChipData trait}}>
            {{#if trait.icon}}<i class="{{trait.icon}}" aria-hidden="true"></i>{{/if}}
            <span class="trait-name">{{trait.name}}</span>
        </div>
        {{/each}}
        {{else if value}}
        {{#each value as |traitId|}}
        <div class="trait-chip trait-chip-readonly" style="{{traitChipStyleFromId traitId}}"
            data-trait-id="{{traitId}}">
            {{#if (traitIconFromId traitId)}}<i class="{{traitIconFromId traitId}}" aria-hidden="true"></i>{{/if}}
            <span class="trait-name">{{traitNameFromId traitId}}</span>
        </div>
        {{/each}}
        {{/if}}
    </div>
    {{/if}}

    <!-- Hidden inputs to store the actual trait IDs as array -->
    {{#each value as |traitId|}}
    <input type="hidden" name="{{../name}}[]" value="{{traitId}}">
    {{/each}}

    {{#if hint}}
    <small id="{{name}}-hint" class="form-text text-muted">{{hint}}</small>
    {{/if}}
</div>