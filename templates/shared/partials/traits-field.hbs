{{!--
Traits Field Component

Usage:
{{> "systems/avant/templates/shared/partials/traits-field"
name="system.traits"
displayTraits=displayTraits
label="Traits"
hint="Add traits to categorize this item"
class="custom-class"
editable=editable
}}

Required: name, label
Optional: hint, class, editable (defaults to true), displayTraits
--}}

{{!-- DEBUGGING: Use Handlebars helper to trace context (inline JS disabled in FoundryVTT v13+) --}}
{{debugContext "TRAITS-FIELD displayTraits" displayTraits}}
{{debugContext "TRAITS-FIELD testTraits" testTraits}}
{{debugContext "TRAITS-FIELD traitsData" traitsData}}
{{debugContext "TRAITS-FIELD value" value}}

<div class="form-group {{#if class}}{{class}}{{/if}}">
    <label for="{{name}}" class="form-label">
        {{label}}
    </label>

    {{#if (ne editable false)}}
    <!-- Edit mode: Trait chip input with autocomplete -->
    <div class="trait-chip-input">
        <div class="trait-chips">
            {{!-- Smart trait display: detect enhanced objects vs raw IDs in value parameter --}}
            {{#if value}}
            {{#each value as |traitItem|}}
            {{#if traitItem.name}}
            {{!-- Enhanced trait object with name, color, icon --}}
            <div class="trait-chip" style="background-color: {{traitItem.color}}; color: {{traitItem.textColor}};"
                data-trait-id="{{traitItem.id}}" data-trait-type="{{traitItem.type}}"
                data-trait-source="{{traitItem.source}}">
                {{#if traitItem.icon}}<i class="{{traitItem.icon}}" aria-hidden="true"></i>{{/if}}
                <span class="trait-name">{{traitItem.name}}</span>
                <button type="button" class="trait-remove" data-action="removeTrait" data-trait-id="{{traitItem.id}}"
                    aria-label="Remove {{traitItem.name}}">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            {{else}}
            {{!-- Raw trait ID - use fallback helpers --}}
            <div class="trait-chip" style="{{traitChipStyleFromId traitItem}}" data-trait-id="{{traitItem}}">
                {{#if (traitIconFromId traitItem)}}<i class="{{traitIconFromId traitItem}}"
                    aria-hidden="true"></i>{{/if}}
                <span class="trait-name">{{traitNameFromId traitItem}}</span>
                <button type="button" class="trait-remove" data-action="removeTrait" data-trait-id="{{traitItem}}"
                    aria-label="Remove {{traitNameFromId traitItem}}">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
            </div>
            {{/if}}
            {{/each}}
            {{/if}}
        </div>

        <!-- Drag-and-Drop Zone (Phase 2 Feature) -->
        <div class="trait-drop-zone" data-drop-zone="trait" style="display: none;">
            <div class="drop-zone-content">
                <i class="fas fa-plus-circle"></i>
                <span class="drop-zone-text">Drag traits from compendium here</span>
            </div>
            <div class="drop-zone-highlight"></div>
        </div>

        <div class="trait-input-container">
            <input type="text" class="trait-autocomplete" placeholder="Type to add traits..." autocomplete="off"
                data-target="{{name}}" {{#if hint}}aria-describedby="{{name}}-hint" {{/if}}>
            <div class="trait-suggestions" style="display: none;"></div>
        </div>
    </div>
    {{else}}
    <!-- Read-only mode: Display trait chips without input -->
    <div class="trait-display">
        {{#if value}}
        {{#each value as |traitItem|}}
        {{#if traitItem.name}}
        {{!-- Enhanced trait object with name, color, icon --}}
        <div class="trait-chip trait-chip-readonly"
            style="background-color: {{traitItem.color}}; color: {{traitItem.textColor}};"
            data-trait-id="{{traitItem.id}}" data-trait-type="{{traitItem.type}}"
            data-trait-source="{{traitItem.source}}">
            {{#if traitItem.icon}}<i class="{{traitItem.icon}}" aria-hidden="true"></i>{{/if}}
            <span class="trait-name">{{traitItem.name}}</span>
        </div>
        {{else}}
        {{!-- Raw trait ID - use fallback helpers --}}
        <div class="trait-chip trait-chip-readonly" style="{{traitChipStyleFromId traitItem}}"
            data-trait-id="{{traitItem}}">
            {{#if (traitIconFromId traitItem)}}<i class="{{traitIconFromId traitItem}}" aria-hidden="true"></i>{{/if}}
            <span class="trait-name">{{traitNameFromId traitItem}}</span>
        </div>
        {{/if}}
        {{/each}}
        {{/if}}
    </div>
    {{/if}}

    <!-- Hidden inputs to store the actual trait IDs as array -->
    {{#each value as |traitItem|}}
    {{#if traitItem.name}}
    {{!-- Enhanced trait object - use the ID --}}
    <input type="hidden" name="{{../name}}[]" value="{{traitItem.id}}">
    {{else}}
    {{!-- Raw trait ID --}}
    <input type="hidden" name="{{../name}}[]" value="{{traitItem}}">
    {{/if}}
    {{/each}}

    {{#if hint}}
    <small id="{{name}}-hint" class="form-text text-muted">{{hint}}</small>
    {{/if}}
</div>