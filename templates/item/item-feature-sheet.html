<!-- Feature Item Sheet Template -->
<form class="{{cssClass}} flexcol" autocomplete="off">
    <header class="sheet-header">
        <img class="profile-img" src="{{item.img}}" data-edit="img" title="{{item.name}}" height="64" width="64"/>
        <div class="header-fields">
            <h1 class="charname"><input name="name" type="text" value="{{item.name}}" placeholder="Feature Name"/></h1>
        </div>
    </header>

    <nav class="sheet-tabs tabs" data-group="primary">
        <a class="item" data-tab="description">Description</a>
        <a class="item" data-tab="details">Details</a>
    </nav>

    <section class="sheet-body">
        <div class="tab" data-group="primary" data-tab="description">
            <div class="form-group">
                <label>Description</label>
                <textarea name="system.description" rows="8">{{system.description}}</textarea>
            </div>
            
            <!-- Trait Management Section -->
            <div class="form-group">
                <label>Traits</label>
                {{#if editable}}
                    <!-- Edit mode: Trait chip input -->
                    <div class="trait-chip-input" data-trait-input="true">
                        <div class="trait-chip-input__field" tabindex="0">
                            <!-- Existing trait chips -->
                            {{#each displayTraits as |trait|}}
                                <span class="trait-chip trait-chip--removable" data-trait="{{trait.id}}">
                                    <span class="trait-chip__text">{{trait.name}}</span>
                                    <button type="button" class="trait-chip__remove" aria-label="Remove trait">Ã—</button>
                                </span>
                            {{/each}}
                            <!-- Input field for adding new traits -->
                            <input type="text" class="trait-chip-input__input" placeholder="Add trait..." autocomplete="off" />
                        </div>
                        <!-- Dropdown for autocomplete suggestions (hidden by default) -->
                        <div class="trait-chip-input__dropdown" data-trait-dropdown="true">
                            <div class="trait-chip-input__no-results">No matching traits found</div>
                        </div>
                        <!-- Hidden input to store actual trait data -->
                        <input type="hidden" name="system.traits" value="{{json system.traits}}" data-trait-data="true" />
                    </div>
                {{else}}
                    <!-- View mode: Display trait chips -->
                    <div class="trait-chips trait-chips--readonly">
                        {{#each displayTraits as |trait|}}
                            <span class="trait-chip" data-trait="{{trait.id}}">
                                <span class="trait-chip__text">{{trait.name}}</span>
                            </span>
                        {{else}}
                            <span class="trait-chips__empty">No traits assigned</span>
                        {{/each}}
                    </div>
                {{/if}}
            </div>
        </div>

        <div class="tab" data-group="primary" data-tab="details">
            <div class="form-group">
                <label>Type</label>
                <input type="text" name="type" value="feature" readonly/>
            </div>

            <div class="form-group">
                <label>Category</label>
                <select name="system.category">
                    {{#select system.category}}
                    <option value="racial">Racial</option>
                    <option value="class">Class</option>
                    <option value="background">Background</option>
                    <option value="general">General</option>
                    <option value="special">Special</option>
                    {{/select}}
                </select>
            </div>

            <div class="form-group">
                <label>Active Feature</label>
                <input type="checkbox" name="system.isActive" {{checked system.isActive}}/>
            </div>

            <div class="form-group">
                <label>Power Point Cost</label>
                <input type="number" name="system.powerPointCost" value="{{system.powerPointCost}}" min="0"/>
            </div>

            <div class="form-group">
                <label>Uses</label>
                <div class="form-fields">
                    <input type="number" name="system.uses.value" value="{{system.uses.value}}" placeholder="Current" min="0"/>
                    <span>/</span>
                    <input type="number" name="system.uses.max" value="{{system.uses.max}}" placeholder="Maximum" min="0"/>
                </div>
            </div>

            <!-- Trait Configuration Section -->
            <fieldset class="trait-configuration">
                <legend>Trait Configuration</legend>
                <p class="hint">Configure these fields to make this item appear as a custom trait in autocomplete. Leave blank if this is a regular feature.</p>
                
                <div class="form-group">
                    <label>Trait Color</label>
                    <input type="text" name="system.color" value="{{system.color}}" placeholder="#FF5733" 
                           title="Hex color code for the trait chip (e.g., #FF5733)"/>
                </div>

                <div class="form-group">
                    <label>Trait Icon</label>
                    <input type="text" name="system.icon" value="{{system.icon}}" placeholder="fas fa-fire" 
                           title="FontAwesome icon class (e.g., fas fa-fire, fas fa-snowflake)"/>
                </div>

                <div class="form-group">
                    <label>Trait Localization Key</label>
                    <input type="text" name="system.localKey" value="{{system.localKey}}" placeholder="CUSTOM.Trait.MyTraitName" 
                           title="Unique identifier for this trait (e.g., CUSTOM.Trait.FireBlade)"/>
                </div>

                {{#if system.color}}
                    {{#if system.icon}}
                        <div class="trait-preview">
                            <label>Preview:</label>
                            <span class="trait-chip trait-chip--preview" style="background-color: {{system.color}};">
                                <i class="{{system.icon}}"></i>
                                <span class="trait-chip__text">{{item.name}}</span>
                            </span>
                        </div>
                    {{/if}}
                {{/if}}
            </fieldset>
        </div>
    </section>
</form>