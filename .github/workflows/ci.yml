name: CI - AvantVTT with Deprecation Guards

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly monitoring every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: "18"
  
jobs:
  lint-and-guard:
    runs-on: ubuntu-latest
    name: "Phase 4: Deprecation Guards & Linting"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for change detection

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Phase 4 Guard - Check deprecated folder modifications
        run: |
          echo "üîç Phase 4: Checking for deprecated folder modifications..."
          
          # Get list of changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            # For push events, check last commit
            CHANGED_FILES=$(git diff --name-only HEAD~1...HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check for deprecated folder edits
          REMOTE_CHANGES=$(echo "$CHANGED_FILES" | grep "^deprecated/remote-trait-service/" || true)
          ACCESSIBILITY_CHANGES=$(echo "$CHANGED_FILES" | grep "^deprecated/accessibility/" || true)
          
          if [ -n "$REMOTE_CHANGES" ]; then
            echo "‚ùå PHASE 4 GUARD VIOLATION: Detected changes to deprecated remote-trait-service folder"
            echo "Modified deprecated files:"
            echo "$REMOTE_CHANGES"
            echo ""
            echo "üîß To edit deprecated files intentionally, include 'restore-remote-trait-service' in your commit message"
            echo "üìñ See deprecated/remote-trait-service/README.md for restoration procedures"
            
            # Check commit messages for restoration keyword
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              COMMIT_MESSAGES=$(git log --pretty=format:"%s" origin/${{ github.base_ref }}...HEAD)
            else
              COMMIT_MESSAGES=$(git log --pretty=format:"%s" HEAD~1...HEAD)
            fi
            
            if echo "$COMMIT_MESSAGES" | grep -q "restore-remote-trait-service"; then
              echo "‚úÖ Found restoration keyword in commit message - allowing edit"
            else
              echo "‚ùå No restoration keyword found - blocking edit"
              exit 1
            fi
          fi
          
          if [ -n "$ACCESSIBILITY_CHANGES" ]; then
            echo "‚ùå PHASE 4 GUARD VIOLATION: Detected changes to deprecated accessibility folder"
            echo "Modified deprecated files:"
            echo "$ACCESSIBILITY_CHANGES"
            echo ""
            echo "üîß To edit deprecated files intentionally, include 'restore-accessibility-module' in your commit message"
            echo "üìñ See deprecated/accessibility/README.md for restoration procedures"
            
            # Check commit messages for restoration keyword
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              COMMIT_MESSAGES=$(git log --pretty=format:"%s" origin/${{ github.base_ref }}...HEAD)
            else
              COMMIT_MESSAGES=$(git log --pretty=format:"%s" HEAD~1...HEAD)
            fi
            
            if echo "$COMMIT_MESSAGES" | grep -q "restore-accessibility-module"; then
              echo "‚úÖ Found restoration keyword in commit message - allowing edit"
            else
              echo "‚ùå No restoration keyword found - blocking edit"
              exit 1
            fi
          fi
          
          if [ -z "$REMOTE_CHANGES" ] && [ -z "$ACCESSIBILITY_CHANGES" ]; then
            echo "‚úÖ No deprecated folder modifications detected"
          fi

      - name: Phase 4 Guard - Check for deprecated imports
        run: |
          echo "üîç Phase 4: Scanning for deprecated imports in active code..."
          
          # Use the enhanced guard script that checks both RemoteTraitService and accessibility
          npm run guard:deprecated
          
          echo "‚úÖ No deprecated imports found in active code"

      - name: Run dead-code scan
        run: |
          echo "üîç Phase 4: Running automated dead-code scan..."
          npm run lint:deadcode || {
            echo "‚ùå Dead code scan failed - found unused dependencies or imports"
            echo "üîß Run 'npm run lint:deadcode' locally to see details"
            exit 1
          }
          echo "‚úÖ Dead-code scan passed"

      - name: Run ESLint
        run: |
          echo "üîç Running ESLint..."
          npm run lint
          echo "‚úÖ ESLint passed"

  test:
    runs-on: ubuntu-latest
    needs: lint-and-guard
    name: "Test Suite"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: |
          echo "üß™ Running test suite..."
          npm test
          echo "‚úÖ Tests passed"

      - name: Check test coverage
        run: |
          echo "üìä Checking test coverage thresholds..."
          # Coverage is reported by Jest based on jest.config.js thresholds
          echo "‚úÖ Coverage check completed"

  build:
    runs-on: ubuntu-latest
    needs: test
    name: "Build & Validate"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build system
        run: |
          echo "üèóÔ∏è Building AvantVTT system..."
          npm run build
          echo "‚úÖ Build completed"

      - name: Validate distribution package
        run: |
          echo "üîç Validating dist/ package..."
          
          # Check that dist/ was created
          if [ ! -d "dist" ]; then
            echo "‚ùå dist/ directory not created"
            exit 1
          fi
          
          # Check for deprecated service references in dist/
          REMOTE_VIOLATIONS=$(find dist/ -name "*.js" | xargs grep -l "RemoteTraitService" || true)
          ACCESSIBILITY_VIOLATIONS=$(find dist/ -name "*.js" | xargs grep -l "from.*accessibility\|import.*accessibility" || true)
          
          if [ -n "$REMOTE_VIOLATIONS" ]; then
            echo "‚ùå PHASE 4 VIOLATION: Found RemoteTraitService references in dist/"
            echo "Files with violations:"
            echo "$REMOTE_VIOLATIONS"
            exit 1
          fi
          
          if [ -n "$ACCESSIBILITY_VIOLATIONS" ]; then
            echo "‚ùå PHASE 4 VIOLATION: Found accessibility module references in dist/"
            echo "Files with violations:"
            echo "$ACCESSIBILITY_VIOLATIONS"
            exit 1
          fi
          
          echo "‚úÖ No deprecated references in dist/ package"
          
          echo "‚úÖ Distribution package validation passed"

      - name: Phase 4 completion check
        run: |
          echo "üéØ Phase 4: Deprecation guards successfully enforced"
          echo ""
          echo "‚úÖ Phase 4 Achievements:"
          echo "  üîí CI guards prevent deprecated folder edits without keyword"
          echo "  üîç Automated scanning prevents deprecated module re-imports"
          echo "  üßπ Dead-code detection integrated into pipeline"
          echo "  üì¶ Distribution package verified clean of deprecated references"
          echo "  üöÄ Build and test pipeline successful"
          echo "  ‚ôø Accessibility module fully deprecated and monitored"
          echo ""
          echo "üìã Long-term safeguards: Weekly monitoring and policy enforcement active"

  weekly-guard-monitor:
    # This job runs weekly to monitor guard integrity
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    name: "Weekly: Guard Integrity Monitor"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Monitor guard integrity
        run: |
          echo "üìä Weekly Guard Integrity Monitor"
          echo "================================"
          
          # Check pre-commit hook exists
          if [ -f ".git/hooks/pre-commit" ]; then
            echo "‚úÖ Pre-commit hook exists"
          else
            echo "‚ö†Ô∏è Pre-commit hook missing"
          fi
          
          # Run deprecated import guard
          echo "üîç Running weekly deprecated import guard..."
          npm run guard:deprecated
          
          # Run dead-code scan
          echo "üîç Running weekly dead-code scan..."
          npm run lint:deadcode
          
          # Check deprecated folder size
          DEPRECATED_SIZE=$(du -sh deprecated/ | cut -f1)
          echo "üì¶ Deprecated folder size: $DEPRECATED_SIZE"
          
          # Count files in deprecated folder
          DEPRECATED_FILES=$(find deprecated/ -type f | wc -l)
          echo "üìÑ Deprecated files count: $DEPRECATED_FILES"
          
          # Specific check for accessibility module archive integrity
          if [ -d "deprecated/accessibility" ]; then
            ACCESSIBILITY_FILES=$(find deprecated/accessibility -type f | wc -l)
            echo "üìÑ Accessibility archive files: $ACCESSIBILITY_FILES"
          else
            echo "‚ö†Ô∏è Accessibility archive directory missing"
          fi
          
          # Check that accessibility module is not in active codebase
          ACCESSIBILITY_IMPORTS=$(find scripts tests -name "*.ts" -o -name "*.js" 2>/dev/null | xargs grep -l "import.*accessibility\|from.*accessibility" 2>/dev/null | grep -v deprecated || true)
          if [ -n "$ACCESSIBILITY_IMPORTS" ]; then
            echo "‚ùå Found accessibility imports in active code:"
            echo "$ACCESSIBILITY_IMPORTS"
          else
            echo "‚úÖ No accessibility imports in active code"
          fi
          
          echo "‚úÖ Weekly monitoring completed" 